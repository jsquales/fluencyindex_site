{% extends "base.html" %}

{% block content %}
<section class="auth-section">
  <div class="auth-card">
    <h1>Math Rush Session Detail</h1>
    <p class="auth-intro">
      Device: <strong id="device-id-text"></strong>
      | Session: <strong id="session-id-text"></strong>
    </p>

    <div class="helper-text" style="display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem;">
      <label>
        Fast threshold (seconds):
        <input id="fast-threshold" type="number" step="0.1" value="2.0" style="margin-left:0.35rem; width:6rem;">
      </label>
      <label>
        Slow threshold (seconds):
        <input id="slow-threshold" type="number" step="0.1" value="5.0" style="margin-left:0.35rem; width:6rem;">
      </label>
    </div>

    <div id="summary" class="helper-text" style="margin-bottom:1rem;">Loading summary...</div>

    <div style="overflow-x:auto;">
      <table style="width:100%; border-collapse:collapse; font-size:0.92rem;">
        <thead>
          <tr>
            <th style="text-align:left; padding:0.55rem; border-bottom:1px solid var(--border);">Problem</th>
            <th style="text-align:left; padding:0.55rem; border-bottom:1px solid var(--border);">Answer</th>
            <th style="text-align:left; padding:0.55rem; border-bottom:1px solid var(--border);">Correct</th>
            <th style="text-align:left; padding:0.55rem; border-bottom:1px solid var(--border);">Elapsed (s)</th>
            <th style="text-align:left; padding:0.55rem; border-bottom:1px solid var(--border);">Time</th>
          </tr>
        </thead>
        <tbody id="events-body">
          <tr>
            <td colspan="5" style="padding:0.8rem; color:var(--text-muted);">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
  const deviceId = {{ device_id | tojson }};
  const clientSessionId = {{ client_session_id | tojson }};

  const deviceIdText = document.getElementById("device-id-text");
  const sessionIdText = document.getElementById("session-id-text");
  const fastThresholdInput = document.getElementById("fast-threshold");
  const slowThresholdInput = document.getElementById("slow-threshold");
  const summaryEl = document.getElementById("summary");
  const eventsBody = document.getElementById("events-body");
  let eventsData = [];

  deviceIdText.textContent = String(deviceId);
  sessionIdText.textContent = String(clientSessionId);

  function val(v) {
    return v === null || v === undefined ? "-" : String(v);
  }

  function esc(v) {
    return val(v)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function fmtTime(ms) {
    if (ms === null || ms === undefined) return "-";
    const num = Number(ms);
    if (!Number.isFinite(num) || num <= 0) return "-";
    return new Date(num).toLocaleString();
  }

  function fmtElapsedSeconds(ms) {
    const num = Number(ms);
    if (!Number.isFinite(num)) return "-";
    return (num / 1000).toFixed(2);
  }

  function elapsedSecondsNumber(ms) {
    const num = Number(ms);
    if (!Number.isFinite(num)) return null;
    return num / 1000;
  }

  function thresholdValue(inputEl, fallback) {
    const n = Number(inputEl.value);
    return Number.isFinite(n) ? n : fallback;
  }

  function elapsedCellStyle(seconds, fastThreshold, slowThreshold) {
    if (seconds === null) return "";
    if (seconds <= fastThreshold) {
      return "background:#ecfdf3; color:#166534;";
    }
    if (seconds >= slowThreshold) {
      return "background:#fef2f2; color:#991b1b;";
    }
    return "";
  }

  function renderEvents(rows) {
    if (!Array.isArray(rows) || rows.length === 0) {
      eventsBody.innerHTML =
        '<tr><td colspan="5" style="padding:0.8rem; color:var(--text-muted);">No events found.</td></tr>';
      return;
    }

    const fastThreshold = thresholdValue(fastThresholdInput, 2.0);
    const slowThreshold = thresholdValue(slowThresholdInput, 5.0);

    eventsBody.innerHTML = rows.map((r) => {
      const problem = `${esc(r.a)} x ${esc(r.b)}`;
      const correct = r.correct === true ? "Yes" : (r.correct === false ? "No" : "-");
      const secondsNum = elapsedSecondsNumber(r.elapsed_ms);
      const secondsText = secondsNum === null ? "-" : secondsNum.toFixed(2);
      const elapsedStyle = elapsedCellStyle(secondsNum, fastThreshold, slowThreshold);
      return `
        <tr>
          <td style="padding:0.55rem; border-bottom:1px solid var(--border);">${problem}</td>
          <td style="padding:0.55rem; border-bottom:1px solid var(--border);">${esc(r.user_answer)}</td>
          <td style="padding:0.55rem; border-bottom:1px solid var(--border);">${correct}</td>
          <td style="padding:0.55rem; border-bottom:1px solid var(--border); ${elapsedStyle}">${secondsText}</td>
          <td style="padding:0.55rem; border-bottom:1px solid var(--border);">${fmtTime(r.timestamp_ms)}</td>
        </tr>
      `;
    }).join("");
  }

  async function loadSummary() {
    const url = `/api/v1/mr/sessions/recent?device_id=${encodeURIComponent(deviceId)}&limit=200`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Summary HTTP ${res.status}`);
    const rows = await res.json();
    const match = Array.isArray(rows)
      ? rows.find((r) => Number(r.client_session_id) === Number(clientSessionId))
      : null;
    if (!match) {
      summaryEl.textContent = "Session summary not found.";
      return;
    }
    summaryEl.innerHTML =
      `Mode: <strong>${esc(match.mode)}</strong> | ` +
      `Difficulty: <strong>${esc(match.difficulty)}</strong> | ` +
      `Attempted: <strong>${esc(match.attempted)}</strong> | ` +
      `Correct: <strong>${esc(match.correct)}</strong> | ` +
      `Avg ms: <strong>${esc(match.avg_ms)}</strong> | ` +
      `Started: <strong>${esc(fmtTime(match.started_at_ms))}</strong> | ` +
      `Ended: <strong>${esc(fmtTime(match.ended_at_ms))}</strong> | ` +
      `Events logged: <strong>${esc(match.events_logged)}</strong>`;
  }

  async function loadEvents() {
    const url =
      `/api/v1/mr/session/events?device_id=${encodeURIComponent(deviceId)}` +
      `&client_session_id=${encodeURIComponent(clientSessionId)}&limit=200`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Events HTTP ${res.status}`);
    eventsData = await res.json();
    renderEvents(eventsData);
  }

  async function loadPage() {
    try {
      await loadSummary();
      await loadEvents();
    } catch (err) {
      summaryEl.textContent = "Failed to load session detail.";
      eventsBody.innerHTML =
        '<tr><td colspan="5" style="padding:0.8rem; color:#b91c1c;">Failed to load events.</td></tr>';
      console.error(err);
    }
  }

  fastThresholdInput.addEventListener("input", () => renderEvents(eventsData));
  slowThresholdInput.addEventListener("input", () => renderEvents(eventsData));

  loadPage();
</script>
{% endblock %}
