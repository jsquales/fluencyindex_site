{% extends "base.html" %}

{% block content %}
<section class="auth-section">
  <div class="auth-card">
    <h1>Recent Math Rush Sessions</h1>
    <p class="auth-intro">Latest 50 sessions from raw Math Rush analytics.</p>

    <div style="overflow-x:auto;">
      <table style="width:100%; border-collapse:collapse; font-size:0.92rem;">
        <thead>
          <tr>
            <th style="text-align:left; padding:0.55rem; border-bottom:1px solid var(--border);">Device ID</th>
            <th style="text-align:left; padding:0.55rem; border-bottom:1px solid var(--border);">Session</th>
            <th style="text-align:left; padding:0.55rem; border-bottom:1px solid var(--border);">Mode</th>
            <th style="text-align:left; padding:0.55rem; border-bottom:1px solid var(--border);">Difficulty</th>
            <th style="text-align:left; padding:0.55rem; border-bottom:1px solid var(--border);">Attempted</th>
            <th style="text-align:left; padding:0.55rem; border-bottom:1px solid var(--border);">Correct</th>
            <th style="text-align:left; padding:0.55rem; border-bottom:1px solid var(--border);">Avg ms</th>
            <th style="text-align:left; padding:0.55rem; border-bottom:1px solid var(--border);">Started</th>
          </tr>
        </thead>
        <tbody id="sessions-body">
          <tr>
            <td colspan="8" style="padding:0.8rem; color:var(--text-muted);">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
  const bodyEl = document.getElementById("sessions-body");

  function fmtStarted(ms) {
    if (ms === null || ms === undefined) return "-";
    const num = Number(ms);
    if (!Number.isFinite(num) || num <= 0) return "-";
    return new Date(num).toLocaleString();
  }

  function val(v) {
    return v === null || v === undefined ? "-" : String(v);
  }

  async function loadSessions() {
    try {
      const res = await fetch("/api/v1/mr/sessions/recent?limit=50");
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      const rows = await res.json();
      if (!Array.isArray(rows) || rows.length === 0) {
        bodyEl.innerHTML = '<tr><td colspan="8" style="padding:0.8rem; color:var(--text-muted);">No sessions found.</td></tr>';
        return;
      }

      bodyEl.innerHTML = rows.map((r) => `
        <tr>
          <td style="padding:0.55rem; border-bottom:1px solid var(--border);">${val(r.device_id)}</td>
          <td style="padding:0.55rem; border-bottom:1px solid var(--border);">${val(r.client_session_id)}</td>
          <td style="padding:0.55rem; border-bottom:1px solid var(--border);">${val(r.mode)}</td>
          <td style="padding:0.55rem; border-bottom:1px solid var(--border);">${val(r.difficulty)}</td>
          <td style="padding:0.55rem; border-bottom:1px solid var(--border);">${val(r.attempted)}</td>
          <td style="padding:0.55rem; border-bottom:1px solid var(--border);">${val(r.correct)}</td>
          <td style="padding:0.55rem; border-bottom:1px solid var(--border);">${val(r.avg_ms)}</td>
          <td style="padding:0.55rem; border-bottom:1px solid var(--border);">${fmtStarted(r.started_at_ms)}</td>
        </tr>
      `).join("");
    } catch (err) {
      bodyEl.innerHTML = '<tr><td colspan="8" style="padding:0.8rem; color:#b91c1c;">Failed to load sessions.</td></tr>';
      console.error(err);
    }
  }

  loadSessions();
</script>
{% endblock %}
